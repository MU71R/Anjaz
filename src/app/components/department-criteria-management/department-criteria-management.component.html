<div class="container py-4" dir="rtl">
  <div class="sidebar-container">
    <app-sidebar></app-sidebar>
  </div>

  <div class="main-content">
    <div class="page-header">
      <div class="header-content">
        <div class="header-text">
          <h4 class="mb-1">إدارة الأقسام والمعايير</h4>
          <p class="mb-0 text-muted">إدارة المعايير الرئيسية والفرعية بشكل هرمي ومنظم</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary shadow" (click)="openMainModal()" [disabled]="isSubmitting">
            <i class="bi bi-plus-lg me-2"></i>
            <span class="btn-text">إضافة معيار رئيسي</span>
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
      </div>
      <p class="text-muted mt-2">جاري تحميل البيانات...</p>
    </div>

    <div *ngIf="!isLoading && mainCriteria.length === 0; else listBlock">
      <div class="empty-state-card">
        <div class="empty-state-icon">
          <i class="bi bi-plus-circle"></i>
        </div>
        <h5 class="mb-1">لا توجد معايير رئيسية</h5>
        <p class="text-muted mb-3">ابدأ بإضافة معيار رئيسي جديد</p>
        <button class="btn btn-primary" (click)="openMainModal()">
          <i class="bi bi-plus-lg me-2"></i> إضافة معيار رئيسي
        </button>
      </div>
    </div>

    <ng-template #listBlock>
      <div class="criteria-accordion">
        <div *ngFor="let main of mainCriteria" class="criteria-card">
          <div class="criteria-header">
            <div class="criteria-info">
              <button class="btn btn-sm toggle-btn" (click)="toggleExpanded(main._id)"
                [attr.aria-expanded]="expandedCriteria.has(main._id)"
                [attr.aria-label]="expandedCriteria.has(main._id) ? 'طي القسم' : 'توسيع القسم'">
                <i class="bi" [ngClass]="expandedCriteria.has(main._id) ? 'bi-chevron-down' : 'bi-chevron-left'"></i>
              </button>

              <div class="criteria-details">
                <div class="criteria-title">
                  <h6 class="mb-0">{{ main.name }}</h6>
                  <div class="badges-container">
                    <span class="badge level-badge">{{ levelLabel(main.level) }}</span>
                    <span *ngIf="main.sector" class="badge sector-badge">{{ main.sector.name }}</span>
                    <span *ngIf="main.departmentUser" class="badge dept-badge">{{ main.departmentUser.fullname }}</span>
                  </div>
                </div>
                <small class="sub-count">{{ getSubForMain(main._id).length }} معيار فرعي</small>
              </div>
            </div>

            <div class="criteria-actions">
              <button class="btn btn-sm btn-outline-primary" (click)="openSubModal(main._id)" title="إضافة معيار فرعي"
                aria-label="إضافة معيار فرعي">
                <i class="bi bi-plus"></i>
                <span class="action-text">إضافة فرعي</span>
              </button>
              <button class="btn btn-sm btn-outline-secondary" (click)="openMainModal(main)"
                title="تعديل المعيار الرئيسي" aria-label="تعديل المعيار الرئيسي">
                <i class="bi bi-pencil"></i>
                <span class="action-text">تعديل</span>
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="requestDeleteMain(main._id)"
                title="حذف المعيار الرئيسي" aria-label="حذف المعيار الرئيسي">
                <i class="bi bi-trash"></i>
                <span class="action-text">حذف</span>
              </button>
            </div>
          </div>

          <div class="sub-criteria-section" *ngIf="expandedCriteria.has(main._id)">
            <div *ngIf="getSubForMain(main._id).length === 0; else subsList">
              <div class="empty-subs-state">
                <p class="mb-2 text-muted">لا توجد معايير فرعية</p>
                <button class="btn btn-outline-primary btn-sm" (click)="openSubModal(main._id)">
                  <i class="bi bi-plus me-1"></i> إضافة معيار فرعي
                </button>
              </div>
            </div>

            <ng-template #subsList>
              <div class="sub-criteria-list">
                <div *ngFor="let sub of getSubForMain(main._id); let i = index" class="sub-criteria-item">
                  <div class="sub-info">
                    <div class="sub-avatar">
                      {{ i + 1 }}
                    </div>
                    <span class="sub-name">{{ sub.name }}</span>
                  </div>

                  <div class="sub-actions">
                    <button class="btn btn-sm btn-outline-secondary" (click)="openSubModal(main._id, sub)"
                      title="تعديل المعيار الفرعي" aria-label="تعديل المعيار الفرعي">
                      <i class="bi bi-pencil"></i>
                      <span class="action-text">تعديل</span>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="requestDeleteSub(sub._id)"
                      title="حذف المعيار الفرعي" aria-label="حذف المعيار الفرعي">
                      <i class="bi bi-trash"></i>
                      <span class="action-text">حذف</span>
                    </button>
                  </div>
                </div>

                <div class="add-sub-btn-container">
                  <button class="btn btn-outline-primary w-100" (click)="openSubModal(main._id)">
                    <i class="bi bi-plus me-1"></i> إضافة معيار فرعي
                  </button>
                </div>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </ng-template>
  </div>
</div>

<div class="modal-backdrop" *ngIf="isMainModalOpen"></div>
<div class="modal d-block" tabindex="-1" *ngIf="isMainModalOpen" dir="rtl">
  <div class="modal-dialog modal-dialog-responsive modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ editingMain ? 'تعديل المعيار الرئيسي' : 'إضافة معيار رئيسي جديد' }}</h5>
        <button type="button" class="btn-close btn-close-rtl" aria-label="إغلاق" (click)="closeMainModal()"
          [disabled]="isSubmitting"></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="mainName" class="form-label">اسم المعيار الرئيسي *</label>
          <input id="mainName" class="form-control text-end" [(ngModel)]="mainName" name="mainName"
            [disabled]="isSubmitting" placeholder="أدخل اسم المعيار الرئيسي" dir="rtl" />
        </div>

        <div class="form-group">
          <label for="mainLevel" class="form-label">مستوى المعيار *</label>
          <select id="mainLevel" class="form-select text-end" [(ngModel)]="mainLevel" name="mainLevel"
            [disabled]="isSubmitting" title="مستوى المعيار" dir="rtl">
            <option value="SECTOR">مستوى القطاع</option>
            <option value="DEPARTMENT">مستوى القسم (تحت قطاع)</option>
            <option value="ALL">جميع القطاعات</option>
          </select>
        </div>

        <div class="form-group" *ngIf="mainLevel === 'SECTOR'">
          <label for="mainSectorId" class="form-label">القطاع *</label>

          <div *ngIf="isLoadingSectorsDepts" class="loading-alert text-end">
            <i class="bi bi-arrow-repeat spinner me-2"></i>
            جاري تحميل القطاعات...
          </div>

          <div *ngIf="!isLoadingSectorsDepts && (!sectors || sectors.length === 0)" class="warning-alert text-end">
            <i class="bi bi-exclamation-triangle me-2"></i>
            لا توجد قطاعات متاحة. يرجى إضافة قطاعات أولاً.
          </div>

          <select *ngIf="!isLoadingSectorsDepts && sectors && sectors.length > 0" id="mainSectorId"
            class="form-select text-end" [(ngModel)]="mainSectorId" name="mainSectorId" [disabled]="isSubmitting"
            title="القطاع" dir="rtl">
            <option value="">اختر القطاع</option>
            <option *ngFor="let s of sectors" [value]="getSectorId(s)">
              {{ getSectorDisplayName(s) }}
            </option>
          </select>
        </div>

        <div class="form-group" *ngIf="mainLevel === 'DEPARTMENT'">
          <label for="mainDeptId" class="form-label">القسم *</label>

          <div *ngIf="isLoadingSectorsDepts" class="loading-alert text-end">
            <i class="bi bi-arrow-repeat spinner me-2"></i>
            جاري تحميل الأقسام...
          </div>

          <div *ngIf="!isLoadingSectorsDepts && (!departments || departments.length === 0)"
            class="warning-alert text-end">
            <i class="bi bi-exclamation-triangle me-2"></i>
            لا توجد أقسام متاحة. يرجى إضافة أقسام أولاً.
          </div>

          <select *ngIf="!isLoadingSectorsDepts && departments && departments.length > 0" id="mainDeptId"
            class="form-select text-end" [(ngModel)]="mainDeptId" name="mainDeptId" [disabled]="isSubmitting"
            title="القسم" dir="rtl">
            <option value="">اختر القسم</option>
            <option *ngFor="let d of departments" [value]="d._id">
              {{ d.fullname || 'اسم غير محدد' }}
            </option>
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="closeMainModal()" [disabled]="isSubmitting">إلغاء</button>
        <button class="btn btn-primary" (click)="submitMain()" [disabled]="isSubmitting">
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
          {{ editingMain ? 'تحديث' : 'إنشاء' }}
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" *ngIf="isSubModalOpen"></div>
<div class="modal d-block" tabindex="-1" *ngIf="isSubModalOpen" dir="rtl">
  <div class="modal-dialog modal-dialog-responsive modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ editingSub ? 'تعديل المعيار الفرعي' : 'إضافة معيار فرعي جديد' }}</h5>
        <button type="button" class="btn-close btn-close-rtl" aria-label="إغلاق" (click)="closeSubModal()"
          [disabled]="isSubmitting"></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="subName" class="form-label">اسم المعيار الفرعي *</label>
          <input id="subName" class="form-control text-end" [(ngModel)]="subName" name="subName"
            [disabled]="isSubmitting" placeholder="أدخل اسم المعيار الفرعي" dir="rtl" />
        </div>

        <div class="form-group">
          <label class="form-label">المعيار الرئيسي</label>
          <div class="form-control-static text-end" dir="rtl">
            {{ getCurrentMainCriteriaName() }}
          </div>
          <small class="form-hint text-end">المعيار الفرعي سيتم إضافته تحت هذا المعيار الرئيسي</small>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="closeSubModal()" [disabled]="isSubmitting">إلغاء</button>
        <button class="btn btn-primary" (click)="submitSub()" [disabled]="isSubmitting">
          <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
          {{ editingSub ? 'تحديث' : 'إنشاء' }}
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" *ngIf="isConfirmOpen"></div>
<div class="modal d-block" tabindex="-1" *ngIf="isConfirmOpen" dir="rtl">
  <div class="modal-dialog modal-dialog-responsive modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">تأكيد الحذف</h5>
        <button type="button" class="btn-close btn-close-rtl" aria-label="إغلاق" (click)="confirmClose(false)"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0 text-end">{{ confirmMessage }}</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="confirmClose(false)">إلغاء</button>
        <button class="btn btn-danger" (click)="confirmClose(true)">حذف</button>
      </div>
    </div>
  </div>
</div>